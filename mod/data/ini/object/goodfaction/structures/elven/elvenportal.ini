;------------------------------------------------------------------------------
;Elven Mallorn Tree
Object ElvenPortalTree

	SelectPortrait = BPEMallornTree

  Draw = W3DScriptedModelDraw ModuleTag_Draw
		OkToChangeModelColor  = Yes
		StaticModelLODMode = yes
		UseStandardModelNames = Yes
		
		//ExtraPublicBone	= ARCHER01

		DefaultModelConditionState
			Model = EBMalTree
			ParticleSysBone     =  FireFlyBone FireFlies02 FollowBone:Yes
			ParticleSysBone NONE StatueHeroFX
			ParticleSysBone	= None FueltheFiresEmbers
			ParticleSysBone NONE ElvenPortalMist
		 //   WeaponLaunchBone = PRIMARY ARCHER01
		End

	;//	Animation state for build placement cursor
	AnimationState = BUILD_PLACEMENT_CURSOR
		BeginScript
			CurDrawableHideSubObject("N_Window")
			CurDrawableHideSubObject("N_Glow")
   			CurDrawableHideSubObject("V1")
   			CurDrawableHideSubObject("V1a")
			CurDrawableHideSubObject("V2")
			CurDrawableHideSubObject("V2a")
		EndScript
	End
	
	;//	Animation state for phantom structure
	AnimationState = PHANTOM_STRUCTURE
		BeginScript
			CurDrawableHideSubObject("N_Window")
			CurDrawableHideSubObject("N_Glow")
   			CurDrawableHideSubObject("V1")
   			CurDrawableHideSubObject("V1a")
			CurDrawableHideSubObject("V2")
			CurDrawableHideSubObject("V2a")
		EndScript
	End
	
    IdleAnimationState
	End
	
    
    ;------------ Build Up States -------
    ModelConditionState = SNOW AWAITING_CONSTRUCTION
		Model	= EBMalTree_ASKN 
		Texture = EBMalTree.tga EBMalTree_Snow.tga
	End  
		
    ModelConditionState   = AWAITING_CONSTRUCTION 
      Model               = EBMalTree_ASKN
;		ParticleSysBone	  = NONE BuildingDoughnutCloud
    End;
    AnimationState        = AWAITING_CONSTRUCTION
      Animation           =  EBMalTree_A
        AnimationName     =  EBMalTree_ASKL.EBMalTree_ABLD
        AnimationMode     = MANUAL
        AnimationBlendTime = 0
      End
	  Flags				  = START_FRAME_FIRST
    End

	ModelConditionState = SNOW ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
		Model	= EBMalTree_ASKN
		Texture = EBMalTree.tga EBMalTree_Snow.tga
	End  

    ModelConditionState   = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
      Model               = EBMalTree_ASKN
		ParticleSysBone   = CONSTDUSTBONE01 BuildingContructDust FollowBone:Yes
    End;
    
    AnimationState        = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
		Animation           = EBMalTree_A
			AnimationName     = EBMalTree_ASKL.EBMalTree_ABLD
			AnimationMode     = MANUAL
			AnimationBlendTime = 0
		End
		Flags				  = START_FRAME_FIRST
		StateName				= BeingConstructed
		BeginScript
			CurDrawablePlaySound("GondorBarracksBeginConstruction")
		EndScript
    End

      ;--damaged building
      
		ModelConditionState     = DAMAGED
			Model               = EBMalTree_D1
		End  
		AnimationState =	DAMAGED
			EnteringStateFX	= FX_StatueDamaged
			ParticleSysBone = NONE MalTreeleaves
			ParticleSysBone = NONE Maltreedust
		End
		
		
		ModelConditionState     = REALLYDAMAGED
			Model               = EBMalTree_D2
		End  
    	AnimationState =	REALLYDAMAGED
    		Animation	= RubbleAnimation
				AnimationName		=	EBMalTree_D2SK.EBMalTree_D2AN
				AnimationMode		=	ONCE	
	  		End
			EnteringStateFX	= FX_StatueDamaged
		End
		
			
		ModelConditionState  = RUBBLE
			Model         =  EBMalTree_D3
			ParticleSysBone SmokeLarge01 SmokeBuildingLarge
		End
		AnimationState = RUBBLE
			Animation	= RubbleAnimation
				AnimationName		=	EBMalTree_D3SK.EBMalTree_D3AN
				AnimationMode		=	ONCE	
	  		End
	  		EnteringStateFX	= FX_StructureMediumCollapse
		End

		ModelConditionState  = POST_RUBBLE
			Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End
		ModelConditionState  = POST_COLLAPSE
			Model         = None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End
		
	    ModelConditionState = SNOW
			Model = EBMalTree
			Texture = EBMalTree.tga EBMalTree_Snow.tga
        End
  End
  
  ; Draw module just for the hero FX.
	Draw = W3DScriptedModelDraw TheHealEffect
	    ModelConditionState  = NONE
			Model = None
	;		ParticleSysBone NONE StatueHeroFX
			ParticleSysBone	= None FueltheFiresEmbers
		End
	    ModelConditionState  = ACTIVELY_BEING_CONSTRUCTED
			Model = None
		End
	End

  Draw = W3DFloorDraw ModuleTag_DrawFloor    
		StaticModelLODMode = Yes		; THIS NEEDS TO BE COMMENTED OUT WHEN ENGINEERING ENABLES LOD'S IN THE FLOOR DRAW
     ModelName = EBMalTree_Bib
     WeatherTexture		= SNOWY EBMalTree_Bib_snow.tga
  		HideIfModelConditions	=	AWAITING_CONSTRUCTION
  		HideIfModelConditions	=	PARTIALLY_CONSTRUCTED
  End

  ;Draw = W3DScriptedModelDraw ModuleTag_Draw_HCBanner
  ;	OkToChangeModelColor  = Yes
  ;	DefaultModelConditionState
  ;		Model = EBHCMalTree
  ;	End
  ;	MultiPlayerOnly = Yes 
  ;End

	Draw = W3DScriptedModelDraw Draw_BonusEffects
	    DefaultModelConditionState
	      Model = None
	    End
	    AnimationState = ACTIVELY_BEING_CONSTRUCTED
	    End
		AnimationState = UPGRADE_ECONOMY_BONUS
			ParticleSysBone	= None FueltheFiresEmbers
		End
	End

  PlacementViewAngle  = 45
 
  ; ***DESIGN parameters ***
  DisplayName			= EVILMOD:ElvenPortal
  Description			= EVILMOD:ElvenPortalDes
  Side					= Elves
  ;IsTrainable			= No
  EditorSorting			= STRUCTURE
  ThreatLevel			= 1.0
 
  BuildCost           = EVILMOD_PORTAL_COST
  BuildTime           = ELVEN_MALLORN_TREE_BUILDTIME          ; in seconds
  VisionRange         = ELVEN_MALLORN_TREE_SHROUD_CLEAR          ; Shroud clearing distance
  ShroudClearingRange = ELVEN_MALLORN_TREE_SHROUD_CLEAR
  BountyValue         = ELVEN_MALLORN_TREE_BOUNTY_VALUE
  CommandPointBonus	= GENERIC_ECONOMY_COMMAND_POINT_BONUS
  
  CommandSet = SellableCommandSet
  
  ArmorSet
    Conditions        = None
    Armor             = PortalsArmor
    ;DamageFX         = StructureDamageFXNoShake
  End
  
   	WeaponSet
		Conditions	= NONE
		Weapon		= PRIMARY ElvenPortalWeapon
	End 

	; *** AUDIO Parameters ***
	#include "..\..\..\Includes\StandardBuildingEvaEvents.inc"

	VoiceSelect		= ElfMallornTreeSelect				;GondorStatueSelect

	SoundOnDamaged		= BuildingLightDamageWood
	SoundOnReallyDamaged	= BuildingHeavyDamageWood

	VoiceSelectUnderConstruction	= BuildingGoodVoiceSelectUnderConstruction
	VoiceFullyCreated		= EVA:GenericBuildingComplete-Builder-Elf

	UnitSpecificSounds
		UnderConstruction	= BuildingConstructionLoop  	; Built first time
		; UnderRepairFromDamage	= NoSound			; Repaired No animation on the building, so don't bother playing sound
		UnderRepairFromRubble	= BuildingConstructionLoop	; Repaired from completely destroyed (not used???)
	End

	EvaEventDamagedOwner		= UnderAttackResource

	ClientBehavior = AnimationSoundClientBehavior ModuleTag_AnimAudioBehavior
		MaxUpdateRangeCap = 800
		AnimationSound = Sound:StatueHeroicBuildStoneExplode	Animation:RPHeroStat_A.RPHeroStat_A		Frames:620
		AnimationSound = Sound:StatueHeroicBuildStoneDebris1	Animation:RPHeroStat_A.RPHeroStat_A		Frames:635
		AnimationSound = Sound:StatueHeroicBuildStoneDebris2	Animation:RPHeroStat_A.RPHeroStat_A		Frames:650
	End

 	//CampnessValue = CAMPNESS_RESOURCE_BUILDING

  ; *** ENGINEERING Parameters ***

	RadarPriority       = STRUCTURE
	KindOf              = PRELOAD STRUCTURE SELECTABLE IMMOBILE SCORE FS_FACTORY NEED_BASE_FOUNDATION CASTLE_KEEP MADE_OF_WOOD
 

	Body                		= StructureBody ModuleTag_05
	  MaxHealth         		= 18000
	  MaxHealthDamaged        	= ELVEN_MALLORN_TREE_HEALTH_DAMAGED
	  MaxHealthReallyDamaged  	= ELVEN_MALLORN_TREE_HEALTH_REALLY_DAMAGED
	End

	
	Behavior = SlowDeathBehavior ModuleTag_SlowDeathWithoutRubble
		DestructionDelay  = 5000
	End

	Behavior = AIUpdateInterface ModuleTag_SoWeCanUseWeapon
		AutoAcquireEnemiesWhenIdle	= Yes
		MoodAttackCheckRate		= 250
	End
	
	Behavior            = GettingBuiltBehavior GetBuiltBehaviorTag
		WorkerName	= ElvenWorkerNoSelect
		SpawnTimer	= DEFAULT_STRUCTURE_HEALDELAY
	End
	
	Behavior = ProductionUpdate ProductionUpdateModuleTag
		; GiveNoXP                       = Yes  ;disable granting xp when producing units.
	End

	Behavior = TerrainResourceBehavior ModuleTag_MoneyProduction
		Radius		= ELVEN_MALLORN_TREE_MONEY_RANGE	; How far we try to claim ground
		MaxIncome	= 50	; If we were to get all we wanted, how much we would earn.  Linear slope to 0 at 0% claim
		IncomeInterval	= 10000		; How often (in msec) we give that much money
	End

	ClientBehavior = TerrainResourceClientBehavior ModuleTag_MoneyProductionClient
	End
 
	Behavior                  = StructureCollapseUpdate ModuleTag_Collapse
		MinCollapseDelay        = 000
		MaxCollapseDelay        = 000
		CollapseDamping         = .5
		MaxShudder              = 0.6
		MinBurstDelay           = 250
		MaxBurstDelay           = 800
		BigBurstFrequency       = 4
		FXList                  = INITIAL   FX_StructureMediumCollapse
		FXList                  = ALMOST_FINAL  FX_StructureAlmostCollapse
		DestroyObjectWhenDone	= Yes
		CollapseHeight		= 126
	End

	
	Behavior = QueueProductionExitUpdate ModuleTag_11
	   UnitCreatePoint		= X:0.0 Y:0.0 Z:0.0
		NaturalRallyPoint	= X:0.0 Y:0.0 Z:0.0
		ExitDelay			= 300 ; Mainly for the multiple produced Red Guard.  Make them come out one at a time.
	End
 
	Geometry              = CYLINDER
	GeometryMajorRadius   = 40
	GeometryMinorRadius   = 40  
	GeometryHeight        = 76F
	GeometryOffset		= X:0 Y:0 Z:0 
	GeometryIsSmall       = No
	Shadow                = SHADOW_VOLUME
	BuildCompletion     	= PLACED_BY_PLAYER
  
  	GeometryContactPoint	= X:-33		Y:10		Z:0		Repair
	GeometryContactPoint	= X:30		Y:10		Z:0		Repair
End

ChildObject ElvenPORTAL ElvenPortalTree

SelectPortrait = THShrineIluvatarPortrait
	; *** ART Parameters ***

	Draw = W3DScriptedModelDraw ModuleTag_Draw
		OkToChangeModelColor			= Yes
		StaticModelLODMode			= yes
		UseStandardModelNames			= Yes

		;ExtraPublicBone			= ARROW01
		;ExtraPublicBone			= ARROW02
		;ExtraPublicBone			= ARROW03
		;ExtraPublicBone			= ARROW04

		DefaultModelConditionState
 			Model				= eulichtaltar
  			ParticleSysBone			= NONE ElvenPortalMainfx FollowBone:Yes
			ParticleSysBone			= NONE ElvenPortalMist2 FollowBone:Yes
			ParticleSysBone			= NONE ElvenPortalMist3 FollowBone:Yes
			;ParticleSysBone			= NONE ElvenWoodButterflies FollowBone:Yes 
			ParticleSysBone			= NONE ElvenWoodSummonShafts FollowBone:Yes
			ParticleSysBone			= NONE ElvenPortal_Mist FollowBone:Yes  
		End

		;//    Animation state for build placement cursor
 		AnimationState = BUILD_PLACEMENT_CURSOR
 			BeginScript
				CurDrawableHideSubObject("N_Window")
 				CurDrawableHideSubObject("N_Glow")
				CurDrawableHideSubObject("V1")
				CurDrawableHideSubObject("V1a")
				CurDrawableHideSubObject("V2")
			EndScript
		End

		;//    Animation state for phantom structure
		AnimationState = PHANTOM_STRUCTURE
			BeginScript
				CurDrawableHideSubObject("N_Window")
				CurDrawableHideSubObject("N_Glow")
				CurDrawableHideSubObject("V1")
				CurDrawableHideSubObject("V1a")
				CurDrawableHideSubObject("V2")
			EndScript
		End

		IdleAnimationState
			StateName			= STATE_Idle
			Animation			= IdleA
				AnimationName		= eulichtaltar.eulichtaltar
				AnimationMode		= LOOP 
				AnimationBlendTime	= 0
			End

		End    

		;------------ Build Up States -------
		ModelConditionState = SNOW AWAITING_CONSTRUCTION
			Model				= eulichtaltar      
			;Texture			= NBElvnBarx.tga NBElvnBarx_Snow.tga
		End  

		ModelConditionState = AWAITING_CONSTRUCTION 
			Model				= eulichtaltar
		End

		AnimationState = AWAITING_CONSTRUCTION
			Animation			=  eulichtaltar
				AnimationName		=  eulichtaltar.eulichtaltar
				AnimationMode		= MANUAL
				AnimationBlendTime	= 0
			End
			Flags				= START_FRAME_FIRST
		End

		ModelConditionState = SNOW ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
			Model				= eulichtaltar        
			;Texture			= NBElvnBarx.tga NBElvnBarx_Snow.tga
		End  

		ModelConditionState = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
			Model				= eulichtaltar
		End

		AnimationState = ACTIVELY_BEING_CONSTRUCTED PARTIALLY_CONSTRUCTED
			Animation			= eulichtaltar
				AnimationName		= eulichtaltar.eulichtaltar
				AnimationMode		= MANUAL
			End
			ParticleSysBone			= NONE BuildingContructDustExp
			;ParticleSysBone		= NONE ExpElven
			BeginScript
				CurDrawablePlaySound("GondorBarracksBeginConstruction")
			EndScript
		End

		;--damaged building
		ModelConditionState = DAMAGED
			Model				= eulichtaltar
			ParticleSysBone FireSmall01 FireBuildingLarge
			ParticleSysBone FireSmall02 FireBuildingMedium
			ParticleSysBone FireSmall03 FireBuildingMedium
			ParticleSysBone FireSmall04 FireBuildingSmall
			ParticleSysBone FireSmall05 SmokeBuildingLarge
		End

		AnimationState = DAMAGED
			EnteringStateFX			= FX_BuildingDamaged
		End

		ModelConditionState = REALLYDAMAGED
			Model				= eulichtaltar
			ParticleSysBone FireSmall01 FireBuildingLarge
			ParticleSysBone FireSmall02 FireBuildingLarge
			ParticleSysBone FireSmall03 FireBuildingMedium
			ParticleSysBone FireSmall04 SmokeBuildingLarge
			ParticleSysBone FireSmall05 SmokeBuildingLarge
		End

		AnimationState = REALLYDAMAGED
			EnteringStateFX			= FX_BuildingReallyDamaged
			Animation			= RubbleAnimation
				AnimationName		= eulichtaltar.eulichtaltar
				AnimationMode		= ONCE
			End
		End

		ModelConditionState  = RUBBLE
			Model				= eulichtaltar
			ParticleSysBone SmokeLarge01 SmokeBuildingLarge
		End

		AnimationState = RUBBLE
			EnteringStateFX			= FX_StructureMediumCollapse
			Animation			= RubbleAnimation
				AnimationName		= eulichtaltar.eulichtaltar
				AnimationMode		= ONCE
			End
			BeginScript
				CurDrawableHideSubObject("NBElvnBarxDP1")
 				CurDrawableHideSubObject("NBElvnBarxDP2")
				CurDrawableHideSubObject("NBElvnBarxDP3")
				CurDrawableHideSubObject("NBElvnBarxDP4")
			EndScript
		End

		ModelConditionState = POST_RUBBLE
			Model				= None
			ParticleSysBone NONE SmokeBuildingMediumRubble
		End

		ModelConditionState = POST_COLLAPSE
			Model				= None
 			ParticleSysBone NONE SmokeBuildingMediumRubble
		End  
 
	End



	;Draw = W3DScriptedModelDraw ModuleTag_Draw_HCBanner
	;	OkToChangeModelColor			= Yes
	;	DefaultModelConditionState
	;		Model				= NBHCElvnBarx
	;	End
	;	MultiPlayerOnly				= Yes 
	;End

	PlacementViewAngle				= -45

	CommandSet = ElvenPortalCommandSet

End



;------------------------------------------------------------------------------
Object FloodgateFlood_forportal

 	Draw = W3DScriptedModelDraw ModuleTag_01
    	DefaultModelConditionState
	      	Model = None
    	End
  	End
	EditorSorting   = SYSTEM
	KindOf = NO_COLLIDE IMMOBILE UNATTACKABLE INERT 
	ForceLuaRegistration = Yes // I have no AI, but I want to send a fear message so please register me.

	// *** ENGINEERING Parameters ***
	Body = ImmortalBody ModuleTag_02
		MaxHealth = 1    
		InitialHealth = 1
	End

	Behavior = DeletionUpdate ModuleTag_03 // Not LifetimeUpdate, since I can't die.  This will DestroyObject me. 
		MinLifetime = 15000   
		MaxLifetime = 15000   
	End
	
	Behavior = FloodUpdate ModuleTag_FloodCentral
		AngleOfFlow = 0				// In degrees, with 0 as screen right
		DirectionIsRelative = Yes	// If it is relative, it adds the facing of the flood object.
		
		FloodMember
			MemberTemplateName = FloodGateHorse
			ControlPointOffsetOne =		X:0 Y:10 Z:0	// Offset from center point of flood.
			ControlPointOffsetTwo =		X:100 Y:50 Z:0
			ControlPointOffsetThree =	X:100 Y:-50 Z:0
			ControlPointOffsetFour =	X:200 Y:-50 Z:0
			MemberSpeed = 20
		End
		FloodMember
			MemberTemplateName = FloodGateHorse
			ControlPointOffsetOne =		X:0 Y:0 Z:0
			ControlPointOffsetTwo =		X:50 Y:0 Z:0
			ControlPointOffsetThree =	X:100 Y:0 Z:0
			ControlPointOffsetFour =	X:150 Y:0 Z:0
			MemberSpeed = 20
		End
		FloodMember
			MemberTemplateName = FloodGateHorse
			ControlPointOffsetOne =		X:0 Y:-10 Z:0
			ControlPointOffsetTwo =		X:100 Y:-50 Z:0
			ControlPointOffsetThree =	X:100 Y:50 Z:0
			ControlPointOffsetFour =	X:200 Y:50 Z:0
			MemberSpeed = 20
		End
		FloodMember
			MemberTemplateName = FloodGateHorse
			ControlPointOffsetOne =		X:0 Y:0 Z:0
			ControlPointOffsetTwo =		X:0 Y:100 Z:0
			ControlPointOffsetThree =	X:0 Y:100 Z:0
			ControlPointOffsetFour =	X:0 Y:200 Z:0
			MemberSpeed = 20
		End
		FloodMember
			MemberTemplateName = FloodGateHorse
			ControlPointOffsetOne =		X:0 Y:0 Z:0
			ControlPointOffsetTwo =		X:0 Y:-100 Z:0
			ControlPointOffsetThree =	X:0 Y:-100 Z:0
			ControlPointOffsetFour =	X:0 Y:-200 Z:0
			MemberSpeed = 20
		End
	End
	
	Geometry            = BOX
	GeometryMajorRadius = 10.0
	GeometryMinorRadius = 1.0
	GeometryHeight      = 3.0
	GeometryIsSmall     = No
	Shadow              = NONE
End
